{% extends "base.html" %}
{% from "components/citation_input.html" import citation_input %}

{% block title %}Compare &sect; {{ section_id }} - Lens{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ul>
        <li><a href="{{ url_for('browse.index') }}">All Titles</a></li>
        <li><a href="{{ url_for('browse.title', title_num=title_num) }}">Title {{ title_num }}</a></li>
        <li><a href="{{ url_for('browse.section', title_num=title_num, section=section_id, year=year1) }}">&sect; {{ section_id }}</a></li>
        <li>Compare</li>
    </ul>
</nav>

<form method="get" action="{{ url_for('compare.diff', title_num=title_num, section=section_id) }}" class="compare-form">
    <div class="compare-toolbar">
        {{ citation_input(name="other", value=title_num ~ " CFR § " ~ section_id, placeholder="e.g., 29 CFR 1910.134") }}
        <div class="compare-controls">
            <select name="year2" onchange="this.form.submit()">
                {% for y in years %}
                <option value="{{ y }}" {% if y == year2 %}selected{% endif %}>
                    {{ "Current" if y == 0 else y }}
                </option>
                {% endfor %}
            </select>
            <span class="compare-arrow">→</span>
            <select name="year1" onchange="this.form.submit()">
                {% for y in years %}
                <option value="{{ y }}" {% if y == year1 %}selected{% endif %}>
                    {{ "Current" if y == 0 else y }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
</form>

{% if section1 and section1.heading %}
<p class="section-heading-context">{{ section1.heading }}</p>
{% endif %}

{% macro section_nav() %}
<nav class="section-nav compare-nav">
    {% if prev_section %}
    <a href="{{ url_for('compare.diff', title_num=title_num, section=prev_section, year1=year1, year2=year2) }}" role="button" class="outline">
        &larr; &sect; {{ prev_section }}
    </a>
    {% else %}
    <span></span>
    {% endif %}
    {% if next_section %}
    <a href="{{ url_for('compare.diff', title_num=title_num, section=next_section, year1=year1, year2=year2) }}" role="button" class="outline">
        &sect; {{ next_section }} &rarr;
    </a>
    {% endif %}
</nav>
{% endmacro %}

{{ section_nav() }}

{# Helper for detecting reserved/empty sections #}
{% macro word_count_display(wc) %}{% if wc and wc > 0 %}{{ "{:,}".format(wc) }} words{% else %}—{% endif %}{% endmacro %}
{% set is_reserved1 = section1 and section1.heading and 'reserved' in section1.heading.lower() %}
{% set is_reserved2 = section2 and section2.heading and 'reserved' in section2.heading.lower() %}
{% set is_empty1 = section1 and (section1.word_count or 0) == 0 %}
{% set is_empty2 = section2 and (section2.word_count or 0) == 0 %}
{% set both_empty = is_empty1 and is_empty2 %}

{% if section1 and section2 %}
{% set diff = (section1.word_count or 0) - (section2.word_count or 0) %}

{% if both_empty %}
{# Both versions are empty #}
<article class="empty-banner">
    <div class="banner-icon">○</div>
    <div class="banner-content">
        <strong>No Content to Compare</strong>
        <p>This section has no text in either {{ "Current" if year2 == 0 else year2 }} or {{ "Current" if year1 == 0 else year1 }}.</p>
        {% if is_reserved1 or is_reserved2 %}
        <p class="empty-hint">This section is reserved for future regulations.</p>
        {% else %}
        <p class="empty-hint">It may be reserved, reference another section, or have been removed.</p>
        {% endif %}
    </div>
</article>

{% elif not has_changes %}
{# No changes - show single column view with stability banner #}
<article class="no-changes-banner">
    <div class="banner-icon">✓</div>
    <div class="banner-content">
        <strong>No Changes</strong>
        <p>This section is identical between {{ "Current" if year2 == 0 else year2 }} and {{ "Current" if year1 == 0 else year1 }}.</p>
        {% if unchanged_since %}
        <p class="stability-info">Unchanged since at least {{ unchanged_since }}</p>
        {% endif %}
    </div>
</article>
<article class="version-card single-version">
    <header>
        <div class="version-header-left">
            <strong>{{ "Current" if year1 == 0 else year1 }}</strong>
            <span class="word-count">{{ word_count_display(section1.word_count) }}</span>
        </div>
    </header>
    <div class="section-text">
        {{ section1.text | safe }}
    </div>
</article>
{% if available_years|length > 2 %}
<div class="suggest-alternatives">
    <p><strong>Try comparing other years:</strong></p>
    <div class="year-links">
        {% for y in available_years if y != year1 and y != year2 %}
        <a href="{{ url_for('compare.diff', title_num=title_num, section=section_id, year1=year1, year2=y) }}" class="year-link">{{ "Current" if y == 0 else y }}</a>
        {% endfor %}
    </div>
</div>
{% endif %}

{% else %}
{# Has changes - show side-by-side diff #}
{% if is_empty2 and not is_empty1 %}
{# Section added (empty -> content) #}
<article class="added-banner">
    <div class="banner-icon">+</div>
    <div class="banner-content">
        <strong>Section Added</strong>
        <p>This section had no content in {{ "Current" if year2 == 0 else year2 }} but has {{ "{:,}".format(section1.word_count) }} words in {{ "Current" if year1 == 0 else year1 }}.</p>
    </div>
</article>
{% elif is_empty1 and not is_empty2 %}
{# Section removed (content -> empty) #}
<article class="removed-banner">
    <div class="banner-icon">−</div>
    <div class="banner-content">
        <strong>Section Removed</strong>
        <p>This section had {{ "{:,}".format(section2.word_count) }} words in {{ "Current" if year2 == 0 else year2 }} but is now empty in {{ "Current" if year1 == 0 else year1 }}.</p>
    </div>
</article>
{% endif %}
<div class="diff-legend">
    <div class="diff-legend-item"><span class="diff-legend-swatch swatch-remove"></span> Removed (regulatory reduction)</div>
    <div class="diff-legend-item"><span class="diff-legend-swatch swatch-add"></span> Added (regulatory growth)</div>
</div>
<div class="grid compare-versions">
    <article class="version-card version-old{% if is_empty2 %} empty-version{% endif %}">
        <header>
            <div class="version-header-left">
                <strong>{{ "Current" if year2 == 0 else year2 }}</strong>
                <span class="word-count">{{ word_count_display(section2.word_count) }}</span>
            </div>
            <span class="legend-remove">Removed</span>
        </header>
        {% if is_empty2 %}
        <div class="empty-version-content">
            <span class="empty-label">Empty</span>
        </div>
        {% else %}
        <div class="section-text diff-text">
            {% if old_html %}{{ old_html | safe }}{% else %}{{ section2.text | safe }}{% endif %}
        </div>
        {% endif %}
    </article>

    <article class="version-card version-new{% if is_empty1 %} empty-version{% endif %}">
        <header>
            <div class="version-header-left">
                <strong>{{ "Current" if year1 == 0 else year1 }}</strong>
                <span class="word-count">{{ word_count_display(section1.word_count) }}</span>
                {% if diff != 0 %}
                <span class="{% if diff > 0 %}change-positive{% else %}change-negative{% endif %}">
                    ({% if diff > 0 %}+{% endif %}{{ "{:,}".format(diff) }})
                </span>
                {% endif %}
            </div>
            <span class="legend-add">Added</span>
        </header>
        {% if is_empty1 %}
        <div class="empty-version-content">
            <span class="empty-label">Empty</span>
        </div>
        {% else %}
        <div class="section-text diff-text">
            {% if new_html %}{{ new_html | safe }}{% else %}{{ section1.text | safe }}{% endif %}
        </div>
        {% endif %}
    </article>
</div>
{% endif %}

{% elif section1 or section2 %}
{# One version found - show partial data with explanation #}
{% set found_section = section1 or section2 %}
{% set found_year = year1 if section1 else year2 %}
{% set missing_year = year2 if section1 else year1 %}

<article class="partial-data-banner">
    <div class="banner-icon">!</div>
    <div class="banner-content">
        <strong>Section Only Available in {{ "Current" if found_year == 0 else found_year }}</strong>
        <p>&sect; {{ section_id }} was not found for {{ "Current" if missing_year == 0 else missing_year }}.</p>
        {% if missing_year == 0 or missing_year > found_year %}
        <p class="banner-hint">This section may have been removed or renumbered.</p>
        {% else %}
        <p class="banner-hint">This section may not have existed yet or had a different number.</p>
        {% endif %}
    </div>
</article>

{% set found_empty = (found_section.word_count or 0) == 0 %}
<article class="version-card single-version{% if found_empty %} empty-version{% endif %}">
    <header>
        <div class="version-header-left">
            <strong>{{ "Current" if found_year == 0 else found_year }}</strong>
            <span class="word-count">{{ word_count_display(found_section.word_count) }}</span>
        </div>
    </header>
    {% if found_empty %}
    <div class="empty-version-content">
        <span class="empty-label">Empty</span>
    </div>
    {% else %}
    <div class="section-text">
        {{ found_section.text | safe }}
    </div>
    {% endif %}
</article>

{% if available_years %}
<div class="available-years">
    <p><strong>This section is available in:</strong></p>
    <div class="year-links">
        {% for y in available_years %}
        <a href="{{ url_for('compare.diff', title_num=title_num, section=section_id, year1=y, year2=(available_years[1] if available_years|length > 1 and y == available_years[0] else available_years[0])) }}" class="year-link {% if y == found_year %}current{% endif %}">{{ "Current" if y == 0 else y }}</a>
        {% endfor %}
    </div>
</div>
{% endif %}

{% else %}
{# Neither version found #}
<article class="not-found-banner">
    <div class="banner-icon">✗</div>
    <div class="banner-content">
        <strong>Section Not Found</strong>
        <p>&sect; {{ section_id }} could not be found in either {{ "Current" if year2 == 0 else year2 }} or {{ "Current" if year1 == 0 else year1 }}.</p>
    </div>
</article>

{% if available_years %}
<div class="available-years">
    <p><strong>This section is available in:</strong></p>
    <div class="year-links">
        {% for y in available_years %}
        <a href="{{ url_for('compare.diff', title_num=title_num, section=section_id, year1=y, year2=(available_years[1] if available_years|length > 1 and y == available_years[0] else available_years[0])) }}" class="year-link">{{ "Current" if y == 0 else y }}</a>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="no-data-message">
    <p>This section does not appear to exist in any available year. Please check the section number.</p>
    <a href="{{ url_for('browse.title', title_num=title_num) }}" role="button" class="outline">Browse Title {{ title_num }}</a>
</div>
{% endif %}
{% endif %}

{{ section_nav() }}
{% endblock %}
