{% extends "base.html" %}

{% block title %}Compare &sect; {{ section_id }} - CFR Viewer{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ul>
        <li><a href="{{ url_for('browse.index') }}">All Titles</a></li>
        <li><a href="{{ url_for('browse.title', title_num=title_num) }}">Title {{ title_num }}</a></li>
        <li><a href="{{ url_for('browse.section', title_num=title_num, section=section_id, year=year1) }}">&sect; {{ section_id }}</a></li>
        <li>Compare</li>
    </ul>
</nav>

<form method="get" action="{{ url_for('compare.diff', title_num=title_num, section=section_id) }}" class="compare-form">
    <div class="compare-toolbar">
        <div class="citation-row">
            <input type="text" name="other" value="{{ title_num }} CFR § {{ section_id }}" class="citation-input" placeholder="e.g., 29 CFR 1910.134">
            <button type="submit" class="citation-go">Go</button>
        </div>
        <div class="compare-controls">
            <select name="year2" onchange="this.form.submit()">
                {% for y in years %}
                <option value="{{ y }}" {% if y == year2 %}selected{% endif %}>
                    {{ "Current" if y == 0 else y }}
                </option>
                {% endfor %}
            </select>
            <span class="compare-arrow">→</span>
            <select name="year1" onchange="this.form.submit()">
                {% for y in years %}
                <option value="{{ y }}" {% if y == year1 %}selected{% endif %}>
                    {{ "Current" if y == 0 else y }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
</form>

{% if section1 and section1.heading %}
<p class="section-heading-context">{{ section1.heading }}</p>
{% endif %}

{% if section1 and section2 %}
<div class="compare-summary">
    <div class="version-badge version-old">
        <strong>{{ "Current" if year2 == 0 else year2 }}</strong>
        <span>{{ "{:,}".format(section2.word_count or 0) }} words</span>
    </div>
    <div class="version-change">
        {% set diff = (section1.word_count or 0) - (section2.word_count or 0) %}
        {% if diff > 0 %}
            <span class="change-positive">+{{ "{:,}".format(diff) }}</span>
        {% elif diff < 0 %}
            <span class="change-negative">{{ "{:,}".format(diff) }}</span>
        {% else %}
            <span class="change-neutral">No change</span>
        {% endif %}
    </div>
    <div class="version-badge version-new">
        <strong>{{ "Current" if year1 == 0 else year1 }}</strong>
        <span>{{ "{:,}".format(section1.word_count or 0) }} words</span>
    </div>
</div>
{% endif %}

{% if diff_html %}
<article class="diff-article">
    <header>
        <strong>Changes</strong>
        <small class="diff-legend"><span class="legend-add">Added</span> <span class="legend-remove">Removed</span></small>
    </header>
    <div class="diff-container">
        {{ diff_html | safe }}
    </div>
</article>
{% elif section1 and section2 %}
<article>
    <p>No differences found between the two versions.</p>
</article>
{% else %}
<article>
    <p>One or both versions could not be found for comparison.</p>
    {% if not section1 %}
    <p>&sect; {{ section_id }} not found for {{ "current" if year1 == 0 else year1 }}.</p>
    {% endif %}
    {% if not section2 %}
    <p>&sect; {{ section_id }} not found for {{ "current" if year2 == 0 else year2 }}.</p>
    {% endif %}
</article>
{% endif %}

<div class="grid compare-versions">
    {% if section2 %}
    <article class="version-card version-old">
        <header>
            <strong>{{ "Current" if year2 == 0 else year2 }} Version</strong>
        </header>
        <div class="section-text">
            {{ section2.text | safe }}
        </div>
    </article>
    {% endif %}

    {% if section1 %}
    <article class="version-card version-new">
        <header>
            <strong>{{ "Current" if year1 == 0 else year1 }} Version</strong>
        </header>
        <div class="section-text">
            {{ section1.text | safe }}
        </div>
    </article>
    {% endif %}
</div>
{% endblock %}
